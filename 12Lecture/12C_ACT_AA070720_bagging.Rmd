---
title: "Ensemble learning: Bagging"
author: "Victoria Lopez"
date: "7/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Bagging (regression)
stands for bootstrap aggregating. It consists of building multiple different decisin tree models from a single training data set by repeatedly using multiple bootstraped subsets of the data and averaging the models. Here, each tree is build independently to the others. 

## Example: 

```{r}
# https://cran.r-project.org/web/packages/modeldata/modeldata.pdf
library(tidymodels)
library(modeldata)
library(baguette)
```

Biomas Data

Ghugare et al (2014) contains a data set where different biomass fuels are characterized by the amount of certain molecules (carbon, hydrogen, oxygen, nitrogen, and sulfur) and the corresponding higher heating value (HHV)

```{r}
data(biomass, package = "modeldata")
glimpse(biomass)
```
```{r}
?biomass
```

### Cleaning...
##### Training... 

```{r}
biomass_tr <-
  biomass %>%
  filter(dataset == "Training") %>%
  dplyr::select(-dataset, -sample)
biomass_tr
```
##### Testing...

```{r}
biomass_te <-
  biomass %>%
  filter(dataset == "Testing") %>%
  dplyr::select(-dataset, -sample)

```


Code... 
https://baguette.tidymodels.org/reference/bagger.html

```{r}
#control	
#A list of options generated by control_bag().
ctrl <- control_bag(var_imp = TRUE)

# `times` is low to make the examples run faster
set.seed(7687)
# Using formulas
#  multivariate adaptive regression splines (MARS)
mars_bag <- bagger(HHV ~ ., data = biomass_tr, base_model = "MARS", times = 5,
                   control = ctrl)
mars_bag
```
Calculation of variable importance

```{r}
var_imp(mars_bag)
```
```{r}
predict(mars_bag, new_data = biomass_te)
```

```{r}
biomass_trp <- biomass_te %>% mutate(predicciones = predictions$.pred)
```


Some plots are missing... do them. What are these values telling us? 
```{r}
mars_bag
```


### Cleaning...
##### Training... 

```{r}
biomass_tr <-
  biomass %>%
  filter(dataset == "Training") %>%
  select(-dataset, -sample, -sulfur)
biomass_tr
```
##### Testing...

```{r}
biomass_te <-
  biomass %>%
  filter(dataset == "Testing") %>%
  select(-dataset, -sample, -sulfur)

```


Code... 
https://baguette.tidymodels.org/reference/bagger.html

```{r}
#control	
#A list of options generated by control_bag().
ctrl <- control_bag(var_imp = TRUE)

# `times` is low to make the examples run faster
set.seed(7687)
# Using formulas
#  multivariate adaptive regression splines (MARS)
mars_bag <- bagger(carbon ~ ., data = biomass_tr, base_model = "MARS", times = 5,
                   control = ctrl)

mars_bag <- bagger(carbon ~ ., data = biomass_tr, base_model = "C0.5", times = 5,
                   control = ctrl)
mars_bag
```
Calculation of variable importance

```{r}
var_imp(mars_bag)
```
```{r}
predictions = predict(mars_bag, new_data = biomass_te)
predictions
```

```{r}
biomass_te$predictions = predictions$.pred
g <- ggplot(biomass_te, aes(x = carbon, y = predictions)) +
  geom_point() +  geom_line(aes(x = carbon, y = carbon))

g
```



Some plots are missing... do them. What are these values telling us? 
```{r}
mars_bag
```


## Acitivity. Design your own project model (data and bagging model). 
1. Regression (easy, like the one above)
2. Classification (research, read the documentation). 


```{r}
#control	
#A list of options generated by control_bag().
ctrl <- control_bag(var_imp = TRUE)

# `times` is low to make the examples run faster
set.seed(7687)
# Using formulas
#  multivariate adaptive regression splines (MARS)
mars_bag <- bagger(oxygen ~ ., data = biomass_tr, base_model = "MARS", times = 5,
                   control = ctrl)
mars_bag
```
Calculation of variable importance

```{r}
var_imp(mars_bag)
```
```{r}
predict(mars_bag, new_data = biomass_te)
```

```{r}
predictions = predict(mars_bag, new_data = biomass_te)
predictions
```
```{r}
biomass_te$predictions = predictions$.pred
g <- ggplot(biomass_te, aes(x = carbon, y = predictions)) +
  geom_point() +  geom_line(aes(x = carbon, y = carbon))

g
```
```{r}

Boston
```


```{r}

#control	
#A list of options generated by control_bag().
ctrl <- control_bag(var_imp = TRUE)

# `times` is low to make the examples run faster
set.seed(7687)
# Using formulas
#  multivariate adaptive regression splines (MARS)
mars_bag <- bagger(factor(rad) ~ ., data = Boston, base_model = "C5.0", times = 5,
                   control = ctrl)
mars_bag
```
